# ⭐ Starlit Puppet Editor v1.9.0 (Puppet Layer)

**パペットレイヤー機能を実装 - 1本の骨構造による変形システム**

## 🎭 v1.9.0 パペットレイヤー実装

### 🎯 新機能

#### 1. **パペットレイヤー - 1本の骨構造** ✨NEW✨
パペットレイヤーは3つの要素で構成されます：
- **軸アンカー**: 変形の基準点（既存のアンカー）
- **ハンドルアンカー**: 変形用のハンドル、これを動かすと軸を基準に湾曲
- **中間ピン**: カーブを追加するためのピン（うねうねさせたいときに追加）

#### 2. **パペットアンカー追従機能** ✨NEW✨
- 各種レイヤー（画像、口パク、まばたき、揺れモーション）に「パペットアンカーに追従」を追加
- 他のレイヤーがパペットレイヤーのハンドルアンカーに追従可能
- **用途例**: 胴体パペットレイヤーの変形に頭レイヤーが追従

#### 3. **使い方**
1. 「🎭 パペット追加」ボタンで画像を選択
2. プロパティパネルの「🎯 ハンドル設定」をONにしてクリック → ハンドルアンカー配置
3. 「📍 中間ピン追加」をONにしてクリック → カーブ用ピン配置（任意）
4. 再生ヘッドを移動してハンドル・ピンをドラッグ → 自動でキーフレーム登録
5. 他のレイヤーのプロパティで「パペットアンカーに追従」を設定 → ハンドルに追従

#### 4. **パペット設定**
- **変形強度**: 湾曲の強さを調整（0.0～3.0）
- **中間ピン**: カーブを追加（複数配置可能）
- **タイムライン**: ハンドルと各ピンごとにキーフレーム表示

#### 5. **WebGL変形**
- 20x20の細かいメッシュグリッド
- なめらかな曲線変形
- リアルタイムプレビュー

#### 6. **用途**
- 胴体の変形に頭・手足を追従
- 髪の毛の揺れ（ハンドルで先端、中間ピンでカーブ）
- 表情の微調整
- 有機的なアニメーション

---

# ⭐ Starlit Puppet Editor v1.8.7 (Smooth Transform)

**風揺れの変形曲線を滑らか化 - より自然なアニメーションを実現**

## 🔧 v1.8.7 滑らか化バージョン

### 🎯 新機能と改善

#### 1. **風揺れの変形曲線を滑らか化**
- メッシュ分割数を大幅に増加（15→30）
- smoothstep/smootherstep補間を実装
- より細かく自然な変形を実現

#### 2. **揺れモーションの変形曲線も滑らか化** ✨NEW✨
- 風揺れと同じsmoothstep補間を実装
- メッシュ分割数を増加（20→30）
- ピンの影響範囲をsmootherstepで滑らかに
- アンカーからの減衰を自然に
- ガタガタした変形が解消され、より有機的な動きに

#### 3. **アンカー設定とピンモードの競合を修正** 🔧FIX🔧
- アンカー設定モードとピンモードが互いに無効化するように改善
- ピンモード有効時もアンカーを再設定できるように修正
- すべてのモード（アンカー設定、揺れピン、風揺れピン）が正しく切り替わるように
- **キーフレーム入力後もアンカーを再設定できるように修正（重要！）**
- **いつでも何度でもアンカー位置を変更できます**

#### 4. **ピンの影響範囲を改善**
- 単純な2乗補間からsmootherstep補間に変更
- ピン周辺の変形がより自然に
- 急激な変化がなくなり滑らかな減衰を実現

#### 5. **アンカーポイントからの減衰を最適化**
- 線形補間からsmoothstep補間に変更
- アンカーポイントから遠ざかるほど自然に揺れが増加
- より有機的な動きを実現
- 各プリセットの分割数を増加
  - 優しい風: 10→25
  - 普通の風: 15→30
  - 強い風: 20→35
  - 旗: 25→40
  - カーテン: 30→45
  - 水中: 20→35

### 💡 技術的な改善
- **app-windsway.js**: 
  - smoothstep補間関数を追加
  - smootherstep補間関数を追加
  - cosine補間関数を追加
  - ピン影響範囲計算をsmootherstepに変更
  - アンカーポイント減衰計算をsmoothstepに変更
  - デフォルト分割数を30に増加
  - すべてのプリセットの分割数を最適化
  - togglePinMode関数で他のモードを無効化
- **app-bounce.js**: ✨NEW✨
  - smoothstep補間関数を追加
  - smootherstep補間関数を追加
  - ピン影響範囲計算をsmootherstepに変更
  - アンカー距離計算をsmoothstepに変更
  - 弾み方向の距離計算もsmoothstepに変更
  - デフォルト分割数を30に増加
  - 揺れタイプの変形がより滑らかで自然に
  - toggleBouncePinMode関数で他のモードを無効化
  - 🔧 キーフレームに保存されたアンカーではなく、常に現在のレイヤーのアンカーを使用（重要！）
- **app-properties.js**: 🔧FIX🔧
  - setAnchorPointClick関数で他のモードを無効化
  - アンカー設定時にピンモードを自動解除
  - モード切り替えがスムーズに動作するように改善

### ✅ 既存機能はそのまま
- アンカーポイントクリック設定機能
- ピン機能
- すべてのプリセット
- キーフレーム対応

## 🔧 v1.7.2 バグ修正

### 🎯 修正内容
1. **アンカーポイント追加が動作しない問題を修正**
   - クリックイベントハンドラの優先順位を修正
   - `anchorPointPickMode` のチェックを最優先に設定
   - アンカーポイント設定モードが正しく機能するようになりました

2. **弾むアニメーションの反転問題を修正**
   - メッシュ生成のY座標計算を修正
   - 座標系を統一（X・Y両方とも中心が0）
   - ゴムのように自然に伸縮する動きを実現

### 💡 技術的な変更
- **app.js**: キャンバスクリックイベントの優先順位を整理
- **app-bounce.js**: メッシュ生成ロジックの座標系を統一

### 📚 レイヤーパネル常時表示
- **起動時から完全表示** - タイトル、説明、ボタンがすべて表示
- **!important指定による安定化** - CSSの表示優先度を最高レベルに設定
- **JavaScript初期化強化** - DOM読み込み後に明示的に表示を確保

### ⚓ アンカーポイントベースの変形システム
- **ピン機能を排除** - よりシンプルで直感的な操作
- **アンカーポイントが変形の軸に** - アンカーに向かって画像が伸縮
- **わかりやすいUI** - 「アンカーポイント（変形の軸）」と明示

### 💫 使い方
1. 揺れモーションレイヤーを作成
2. **アンカーポイントを設定** - これが変形の軸になります
3. 弾み方向を選択
   - **下に向かって** → アンカーより上が伸縮（胸の揺れなど）
   - **上に向かって** → アンカーより下が伸縮（髪の揺れなど）
4. キーフレームを挿入してアニメーション開始

### 🎯 具体例
- **胸の揺れ** → アンカーを上（胸の付け根）に配置、下に向かってモード
- **髪の揺れ** → アンカーを下（髪の根元）に配置、上に向かってモード
- **しっぽの揺れ** → アンカーを付け根に配置

## ✨ 主な機能

### 🎈 揺れモーション
- **弾み（Y軸伸縮のみ）** - シンプルな上下の弾み
- **揺れ（伸縮+左右揺れ）** - 風揺れベースの複雑な揺れ
- **減衰アニメーション** - 自然な揺れの余韻
- **キーフレーム対応** - 複数回のアニメーション挿入可能

### 🎨 その他の機能
- **タイムラインエディタ** - 30fpsのアニメーション編集
- **キーフレームアニメーション** - 位置、回転、スケール、不透明度
- **風揺れエフェクト** - ピンベースのメッシュ変形
- **口パクレイヤー** - 連番画像による口パクアニメーション
- **まばたきレイヤー** - 自動まばたきアニメーション
- **色抜きクリッピング** - 特定色を抜いてマスク生成
- **親子関係** - レイヤーの階層管理
- **ブレンドモード** - 15種類のブレンドモード対応

## 🎮 基本操作

- **レイヤー追加** - 画像をドラッグ&ドロップ
- **選択** - レイヤーをクリック
- **移動** - ポジションツールでドラッグ
- **回転** - 回転ハンドルツールでドラッグ
- **アンカー設定** - クリック設定ボタンを押してキャンバスをクリック

## 📁 ファイル構成

```
StarlitPuppetEditor_v1_7_2/
├── index.html              メインHTML
├── styles.css              スタイルシート
├── app.js                  アプリケーションメイン（v1.7.2 更新！）
├── app-core.js             コア機能
├── app-layers.js           レイヤー管理
├── app-properties.js       プロパティパネル
├── app-animation.js        キーフレームアニメーション
├── app-timeline.js         タイムライン
├── app-tools.js            ツール操作
├── app-windsway.js         風揺れエフェクト
├── app-bounce.js           揺れモーション（v1.7.2 更新！）
├── app-clipping.js         色抜きクリッピング
├── pins/                   ピン画像（風揺れ用）
└── README.md               このファイル
```

## 🔧 技術仕様

- **レンダリング** - Canvas 2D API + WebGL
- **アニメーション** - 30fps固定
- **メッシュ変形** - 20×10グリッド（揺れモーション）
- **キーフレーム補間** - 線形補間
- **プロジェクト保存** - JSON形式

## 📝 変更履歴

### v1.8.7 滑らか化版 (2025-11-24)
- ✨ 風揺れの変形曲線を大幅に滑らか化
- ✨ 揺れモーションの変形曲線も滑らか化（NEW！）
- 🎯 メッシュ分割数を増加（風揺れ15→30、揺れ20→30）
- 🔧 smoothstep/smootherstep補間を実装（両方に適用）
- 💫 ピンの影響範囲をより自然に（両方に適用）
- 🌊 アンカーポイント減衰をsmoothstepに変更（両方に適用）
- 🎨 すべてのプリセットの分割数を最適化
- 🔥 ガタガタした変形が解消され、より有機的な動きを実現
- 🔧 アンカー設定モードとピンモードの競合を修正（重要！）
- ✅ ピン設定後もアンカーを再設定できるように改善
- 🎯 すべてのモードが正しく切り替わるように修正
- 🔥 **キーフレーム入力後もアンカーを再設定できるように修正（重要！）**
- ✨ キーフレームに保存されたアンカーではなく、常に現在のレイヤーのアンカーを使用

### v1.7.2 バグ修正版 (2025-11-23)
- 🐛 アンカーポイントがクリックしても追加できない問題を修正
- 🐛 弾むアニメーションが反転する問題を修正
- 🎯 座標系を統一してゴムのような自然な伸縮を実現
- 🔧 イベントハンドラの優先順位を最適化

### v1.7.0 レイヤーパネル常時表示版 (2025-11-23)
- 📚 レイヤーパネルを起動時から完全表示
- 🎯 タイトル、説明、全ボタンが常に表示される
- 💪 !important指定による表示の安定化
- 🔧 JavaScript初期化コードで表示を確保

### v1.7.0 (2025-11-23)
- ⚓ アンカーポイントベースの変形システムに移行
- ❌ ピン機能を排除（よりシンプルに）
- 📝 UIの説明を改善
- 🐛 変形の軸の問題を解決

### v1.6.6
- 🎈 揺れモーションレイヤーの安定化
- 🐛 各種バグ修正

## 🎯 今後の予定

- [ ] 揺れモーションの挙動最適化
- [ ] パフォーマンス向上
- [ ] プリセット機能
- [ ] エクスポート機能の強化

## 📜 ライセンス

MIT License

---

**Starlit Puppet Editor v1.8.7 - Smooth Transform**  
アンカーポイントに向かって、画像が躍動する✨  
より滑らかで自然なアニメーションを実現🎨
